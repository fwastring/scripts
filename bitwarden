#!/bin/bash

# Define the clipboard command based on your environment
CLIPBOARD_CMD="xclip -in -selection clipboard"

# Unlock Bitwarden vault if not already unlocked
# This will prompt for your master password if needed.
# Using --raw to get only the session key
BW_SESSION=$(bw unlock --passwordfile ~/secrets/bitwarden --raw)

if [ -z "$BW_SESSION" ]; then
    echo "Bitwarden vault unlock failed or cancelled." >&2
    exit 1
fi

export BW_SESSION

# List items and pipe to dmenu
# You can customize the fields displayed in dmenu
# For example, to show just the name: bw list items --session "$BW_SESSION" --raw | jq -r '.[].name'
# For name and URL: bw list items --session "$BW_SESSION" --raw | jq -r '.[].name + " (" + .[].login.uri + ")"'
SELECTED_ITEM=$(bw list items --session "$BW_SESSION" --raw \
    | jq -r '.[] | .name' \
    | dmenu -c -bw 3 -i -l 10 -p "Bitwarden:")

# Check if an item was selected
if [ -z "$SELECTED_ITEM" ]; then
    echo "No item selected." >&2
    exit 0
fi

# Retrieve the selected item's password and copy to clipboard
# Adjust 'jq' path to get the specific field you want (e.g., .login.username, .login.password)
bw get item "$SELECTED_ITEM" --session "$BW_SESSION" --raw \
    | jq -r '.login.password' \
    | $CLIPBOARD_CMD

# Optional: Clear the clipboard after a few seconds
(sleep 30 && echo "" | $CLIPBOARD_CMD) & disown

echo "Password for '$SELECTED_ITEM' copied to clipboard."

# Lock Bitwarden vault (optional, good practice for security)
bw lock
